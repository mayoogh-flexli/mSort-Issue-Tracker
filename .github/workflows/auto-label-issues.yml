name: Auto-label Issues

on:
  issues:
    types: [opened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Add component and status labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';
            
            // Parse component from issue body
            const componentMatch = body.match(/###\s*ðŸ“‚ Affected Component\s*\n\s*(.+)/i) ||
                                   body.match(/###\s*ðŸ”§ (?:WTM|Infeed) Component\s*\n\s*(.+)/i);
            
            if (componentMatch) {
              const component = componentMatch[1].trim().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/\//g, '-')
                .replace(/[()]/g, '');
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [`component:${component}`]
              });
            }
            
            // Parse priority
            const priorityMatch = body.match(/###\s*ðŸš¨ Priority\s*\n\s*(P[0-3])/i);
            if (priorityMatch) {
              const priority = priorityMatch[1].toLowerCase();
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [priority]
              });
            }
            
            // Parse bot operational status for robot issues
            const botStatusMatch = body.match(/###\s*ðŸš¦ Bot Operational Status\s*\n\s*(.+)/i);
            if (botStatusMatch) {
              const status = botStatusMatch[1].trim().toLowerCase();
              if (status.includes('down')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['bot-down']
                });
              } else if (status.includes('degraded')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['bot-degraded']
                });
              }
            }

            // --- New: detect the issue template used and add 'robot-issue' label when 01-robot-issue was used ---
            // Common GitHub behaviour: when an issue template is used, GitHub inserts a hidden HTML comment like:
            // <!-- template: 01-robot-issue.yml -->
            // Check for that comment first. Fallback: look for the template filename anywhere in the body.
            try {
              const templateCommentMatch = body.match(/<!--\s*template:\s*([^\s>]+)\s*-->/i);
              const templateFilenameMatch = body.match(/01-robot-issue(?:\.ya?ml)?/i);

              let isRobotTemplate = false;

              if (templateCommentMatch) {
                const templateUsed = templateCommentMatch[1].trim().toLowerCase();
                if (templateUsed === '01-robot-issue.yml' || templateUsed === '01-robot-issue') {
                  isRobotTemplate = true;
                }
              } else if (templateFilenameMatch) {
                // fallback: template filename appears in the body
                isRobotTemplate = true;
              }

              if (isRobotTemplate) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['robot-issue']
                });
              }
            } catch (err) {
              // Safe fail: log and continue with other labeling
              console.log('Template detection failed:', err);
            }
            
            console.log('Auto-labeling completed');
