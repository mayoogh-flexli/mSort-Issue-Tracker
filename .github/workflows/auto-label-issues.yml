name: Auto-label Issues

on:
  workflow_dispatch:

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Process all issues
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch all issues (open + closed optional)
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "all",   // or "open" if you only want open issues
                per_page: 100
              }
            );

            console.log(`Found ${issues.length} issues to process`);

            // Import your existing labeling logic as a function
            async function applyLabels(issue) {

              const body = issue.body || '';
              const title = issue.title || '';

              // ----- TITLE MAPPING -----
              const titleLabelMap = [
                { keyword: '[wtm]', label: 'F4_collision' },
                { keyword: '[infeed]', label: 'F5_infeed' }
              ];

              for (const rule of titleLabelMap) {
                if (title.toLowerCase().includes(rule.keyword.toLowerCase())) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: [rule.label]
                  });
                }
              }

              // ----- COMPONENT MAPPING -----
              const componentLabelMap = {
                'drive motor, motherboard': 'F1_bot_movement',
                'station reader': 'F2_station_reader',
                'diverter': 'F3_switching',
                'wtm-issue': 'F4_collision',
                'infeed-issue': 'F5_infeed',
                'afc, electromagnet': 'F6_drop_off',
                'motherboard closure': 'F7_motherboard_closure'
              };

              const compMatch = body.match(/###\s*Affected Component\s*\n\s*(.+)/i);
              if (compMatch) {
                const compRaw = compMatch[1].trim().toLowerCase();
                for (const key in componentLabelMap) {
                  if (compRaw.includes(key)) {
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      labels: [componentLabelMap[key]]
                    });
                  }
                }
              }

              // ----- YOUR EXISTING LABELING LOGIC HERE -----
              // (You can paste your previous regex-based labeling logic here)
            }

            // Loop through all issues and apply labeling rules
            for (const issue of issues) {
              console.log(`Processing Issue #${issue.number}`);
              await applyLabels(issue);
            }

            console.log("Bulk labeling completed.");
